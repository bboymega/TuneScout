## About
A scalable music fingerprinting and recognition algorithm featuring multi-processing, multi-instance support and API integration.

This project is under development, core algorithm based on [worldveil/dejavu](https://github.com/worldveil/dejavu), which is licensed under the MIT License.

## Features

- **Multi-processing**: Enables faster processing times by distributing requests across multiple processing threads or cores and multiple database instances.

- **Result Storage Support**: Supports storing processed results in databases for easy retrieval, analysis, and re-use.

- **Redis Caching**: Utilizes Redis for caching frequently queried audio fingerprints to improve response time and reduce database load.

- **High Performance Database Support**: Supports **ClickHouse** for rapid queries and high-speed data handling for large-scale deployments.

- **Multi Database Instance Support**: A scalable design that enables seamless integration of multiple databases, allowing the recognition engine and result storage to independently scale and handle large volumes of data efficiently across various databases.

- **Resilient Database Instance Handling**: Utilizing the remaining available database instances in the event that some configured database instances are temporaily down or unreachable. **WARNING**: It is not recommended to keep permanently removed or offline database instances in the configuration file, as this may lead to downgraded performance due to continuous retry attempts.

- **Universal Multimedia Format Support**: Automatically converts submitted audio or video data to a standardized WAV format [44.1 kHz (configurable via `DEFAULT_FS`), 16-bit] before processing to handle a wide range of multimedia formats.

- **REST API**: Allows audio data recognition and fingerprinting through URL submission.

- **Rate Limiting**: Configurable settings to manage the rate of incoming requests for recognizing, fetching results and fingerprinting independently.

- **Token authentication and write protection for audio fingerprinting requests**: Ensures that only authorized users can add audio fingerprint data to the database, with built-in write protection to maintain data integrity.

## API Endpoints

### /api/recognize
This endpoint is responsible for processing and recognizing audio input, such as recorded music tracks. When an audio file or stream is submitted to this endpoint, it analyzes the audio's unique fingerprint and compares it against a distributed set of configured audio fingerprinting database instances to identify the music being played. 

The recognition result is stored across a distributed set of configured result storage database instances, which can later be retrieved via a unique `result_token`. The endpoint returns a JSON object containing the top 3 most likely recognitions, based on the comparison with the fingerprinting database set.

Method: `POST`

Parameters:
- `audio_or_video_file (multipart/form-data)`: The audio or video file (or stream) to be recognized, submitted via the `file` parameter.
- Example submission format with Python `requests`: `files = {'file': (f.name, f, mime_type)}`

Response:
- `results`: A JSON array of the top 3 most probable recognitions, each including the track name and its confidence score.
- `status`: Indicates whether the recognition process was successful.
- `token`: A unique token that can be used to retrieve this recognition result.
- `message`: An error message if the process fails (when `{ "status": "error" }`), or if there’s an issue with the request.

### /api/fetch/<Result_Token>
This endpoint retrieves detailed information about a previously recognized audio track, using the unique result token generated by the `/api/recognize` endpoint.

Method: `GET`

Parameters:
- `<Result_Token>` (path parameter):The unique result token associated with a recognized track.

Response:
- `results`: A JSON array of the top 3 most probable recognitions, each including the track name and its confidence score.
- `status`: Indicates whether the recognition process was successful.
- `token`: A unique token that can be used to retrieve this recognition result.
- `message`: An error message if the process fails (when `{ "status": "error" }`), or if there’s an issue with the request.

### /api/fingerprint
This endpoint allows you to submit an audio sample for fingerprinting, which can later be used for matching or recognition purposes. This endpoint is useful for generating a fingerprint for tracks you wish to store and compare later against future recognition requests.

Method: `POST`

Headers:
- Authorization Header: Required authorization header for submission, formatted as `Authorization: Bearer {token}`
- Example: `Authorization: Bearer 12345`

Parameters:
- `audio_or_video_file (multipart/form-data)`: The audio or video file (or stream) to be fingerprinted, submitted via the `file` parameter.
- Example submission format with Python `requests`: `files = {'file': (f.name, f, mime_type)}`
- **Alternative Method**: You can also use the `tunescout_uploader` to upload audio samples for fingerprinting.

Response:
- `file_sha1`: The SHA-1 hash of the submitted audio file.
- `status`: Indicates whether the fingerprinting process was successful or already fingerprinted.
- `message`: An error message if the process fails (when `{ "status": "error" }`), or if there’s an issue with the request.

## Configuration Files

### ./dejavu/config/settings.py
This file serves as the master settings file for the TuneScout music recognition system. It controls key configuration aspects, including the path to the database configuration file (default: `./config.json`) and various fine-tuning parameters for both the fingerprinting and recognition processes.
- Default value for configuration file: `CONFIG_FILE = config.json`

### config.json
This file serves as the configuration file for the distributed audio fingerprinting and result storage database instances, and the bearer token for authenticating fingerprinting requests.

#### Key Sections:
`fingerprinting`:

| Key     | Description                                                                  | Default Value |
| ------- | ---------------------------------------------------------------------------- | ------------- |
| `allow` | A boolean flag indicating whether fingerprinting is enabled (true or false). | `true`        |
| `token` | The bearer token used for authenticating fingerprinting requests.            | `None`        |

`recognizing`:

| Key                | Description                                                                                  | Default Value     |
| ------------------ | -------------------------------------------------------------------------------------------- | ----------------- |
| `max_duration`     | The maximum duration (in seconds) for audio input. Audio longer than this will be truncated. | `None` (No limit) |
| `max_file_size_mb` | The maximum file size (in MB) allowed for audio input.                                       | `None` (No limit) |

`redis`:

Configuring Redis for fingerprint query caching.

| Key                   | Description                                                         | Default Value |
| --------------------- | ------------------------------------------------------------------- | ------------- |
| `host`                | The hostname or IP address of the Redis server.                     | `localhost`   |
| `user` (optional)     | The username to authenticate with the Redis server (if applicable). | `None`        |
| `password` (optional) | The password for connecting to the Redis server (if applicable).    | `None`        |
| `prefix` (optional)   | A string used as the key prefix to store cached data.               | `None`        |
| `port` (optional)     | The port number of the Redis server.                                | `6379`        |


`rate_limit`:

Configuring rate limiting to prevent abuse and ensure fair usage. The rate limits for **fetching results**, **recognizing**, and **fingerprinting** can be set independently.

| Keys               | Description                                                   | Default Value     |
|-----------------------|---------------------------------------------------------------|-------------------|
| `fetching_results`    | The maximum number of requests allowed for fetching results within the time window. | `50 per second` |
| `recognizing`         | The maximum number of requests allowed for recognizing fingerprints within the time window. | `10 per second` |
| `fingerprinting`      | The maximum number of fingerprint creation requests within the time window. | `10 per second` |
| `redis_db_index`      | The Redis database index to use for storing rate limit information. | `0`               |

`allowed_origin`:

Configuring the allowed sources that are allowed to access the API endpoints via cross-origin requests.

| Key              | Description                                                             | Default Value     |
| ---------------- | ----------------------------------------------------------------------- | ----------------- |
| `allowed_origin` | A list of allowed origins (URLs) that can make requests to your system. | `[]` (empty list) |


`instances`:

Configuring the distributed set of audio fingerprinting database instances. Each instance defines a specific database configuration that the TuneScout system will connect to for storing and retrieving fingerprint audio data.

- `database`:

| Key               | Description                                                                                                                               | Default Value                           |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| `host`            | The database instance's IP address or hostname.                                                                                           | `127.0.0.1`                             |
| `user`            | The username for the database instance.                                                                                                   | `None`                                  |
| `password`        | The password to authenticate with the database instance.                                                                                  | `None`                                  |
| `database`        | The name of the specific database to connect to.                                                                                          | `None`                                  |
| `port` (optional) | The port number the database instance is listening on. For MySQL, the default port is `3306`. For Clickhouse, the default port is `9000`. | `3306` for MySQL, `9000` for Clickhouse |

- `database_type`: Specifies the type of database for a specific instance. Currently, `clickhouse` and `mysql` are supported.
- `redis_db_index`: Specifies the Redis cache database index used for a specific instance. This must be a unique integer value for each Redis instance to avoid conflicts between caches.

`results`:

Configuring the distributed set of result storage database instances. Each instance defines a specific database configuration that the TuneScout system will connect to for storing and retrieving recognition results.

- `database`:

| Key               | Description                                                                                                                               | Default Value                           |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| `host`            | The database instance's IP address or hostname.                                                                                           | `127.0.0.1`                             |
| `user`            | The username for the database instance.                                                                                                   | `None`                                  |
| `password`        | The password to authenticate with the database instance.                                                                                  | `None`                                  |
| `database`        | The name of the specific database to connect to.                                                                                          | `None`                                  |
| `port` (optional) | The port number the database instance is listening on. For MySQL, the default port is `3306`. For Clickhouse, the default port is `9000`. | `3306` for MySQL, `9000` for Clickhouse |

- `database_type`: Specifies the type of database for a specific instance. Currently, `clickhouse` and `mysql` are supported.

#### config.json example
```
{
  "fingerprinting": {
    "allow": true,
    "token": "12345"
  },
  "recognizing": {
    "max_duration": 10,
    "max_file_size_mb": 150
  },
  "redis": {
    "host": "127.0.0.1",
    "user": "dejavu",
    "password": "dejavu",
    "prefix": "dejavu",
    "port": 6379
  },
  "rate_limit": {
    "fetching_results": "50 per second",
    "recognizing": "10 per second",
    "fingerprinting": "10 per second",
    "redis_db_index": 0
  },
  "allowed_origin": ["https://example.com"],
  "instances": [
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "dejavu0",
        "port": 9000
      },
      "redis_db_index": 1,
      "database_type": "clickhouse"
    },
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "dejavu1",
        "port": 9000
      },
      "redis_db_index": 2,
      "database_type": "clickhouse"
    }
  ],
  "results": [
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "result0",
        "port": 9000
      },
      "database_type": "clickhouse"
    },
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "result1",
        "port": 9000
      },
      "database_type": "clickhouse"
    }
  ]
}
```
