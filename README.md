## About
A scalable music fingerprinting and recognition algorithm featuring multi-processing, multi-instance support and API integration.

This project is under development, core algorithm based on [worldveil/dejavu](https://github.com/worldveil/dejavu), which is licensed under the MIT License.

## Features

- **Multi-processing**: Enables faster processing times by distributing requests across multiple processing threads or cores and multiple database instances.

- **Result Storage Support**: Supports storing processed results in databases for easy retrieval, analysis, and re-use.

- **High Performance Database Support**: Supports **ClickHouse** for rapid queries and high-speed data handling for large-scale deployments.

- **Multi Database Instance Support**: A scalable design that enables seamless integration of multiple databases, allowing the recognition engine and result storage to independently scale and handle large volumes of data efficiently across various databases.

- **Resilient Database Instance Handling**: Utilizing the remaining available database instances in the event that some configured database instances are temporaily down or unreachable. **WARNING**: It is not recommended to keep permanently removed or offline database instances in the configuration file, as this may lead to downgraded performance due to continuous retry attempts.

- **Universal Multimedia Format Support**: Automatically converts submitted audio or video data to a standardized WAV format [44.1 kHz (configurable via `DEFAULT_FS`), 16-bit] before processing to handle a wide range of multimedia formats.

- **REST API**: Allows audio data recognition and fingerprinting through URL submission.

- **Token authentication and write protection for audio fingerprinting requests**: Ensures that only authorized users can add audio fingerprint data to the database, with built-in write protection to maintain data integrity.

## API Endpoints

### /api/recognize
This endpoint is responsible for processing and recognizing audio input, such as recorded music tracks. When an audio file or stream is submitted to this endpoint, it analyzes the audio's unique fingerprint and compares it against a distributed set of configured audio fingerprinting database instances to identify the music being played. 

The recognition result is stored across a distributed set of configured result storage database instances, which can later be retrieved via a unique `result_token`. The endpoint returns a JSON object containing the top 3 most likely recognitions, based on the comparison with the fingerprinting database set.

Method: `POST`

Parameters:
- `audio_or_video_file (multipart/form-data)`: The audio or video file (or stream) to be recognized, submitted via the `file` parameter.
- Example submission format with Python `requests`: `files = {'file': (f.name, f, mime_type)}`

Response:
- `results`: A JSON array of the top 3 most probable recognitions, each including the track name and its confidence score.
- `status`: Indicates whether the recognition process was successful.
- `token`: A unique token that can be used to retrieve this recognition result.
- `error`: An error message if the process fails, or if there’s an issue with the request.

### /api/fetch/<Result_Token>
This endpoint retrieves detailed information about a previously recognized audio track, using the unique result token generated by the `/api/recognize` endpoint.

Method: `GET`

Parameters:
- `<Result_Token>` (path parameter):The unique result token associated with a recognized track.

Response:
- `results`: A JSON array of the top 3 most probable recognitions, each including the track name and its confidence score.
- `status`: Indicates whether the recognition process was successful.
- `token`: A unique token that can be used to retrieve this recognition result.
- `error`:  An error message if the process fails, or if there’s an issue with the request.

### /api/fingerprint
This endpoint allows you to submit an audio sample for fingerprinting, which can later be used for matching or recognition purposes. This endpoint is useful for generating a fingerprint for tracks you wish to store and compare later against future recognition requests.

Method: `POST`

Headers:
- Authorization Header: Required authorization header for submission, formatted as `Authorization: Bearer {token}`
- Example: `Authorization: Bearer 12345`

Parameters:
- `audio_or_video_file (multipart/form-data)`: The audio or video file (or stream) to be fingerprinted, submitted via the `file` parameter.
- Example submission format with Python `requests`: `files = {'file': (f.name, f, mime_type)}`

Response:
- `file_sha1`: The SHA-1 hash of the submitted audio file.
- `status`: Indicates whether the fingerprinting process was successful or already fingerprinted.
- `error`: An error message if the process fails, or if there’s an issue with the request.

## Configuration Files

### ./dejavu/config/settings.py
This file serves as the master settings file for the TuneScout music recognition system. It controls key configuration aspects, including the path to the database configuration file (default: `./config.json`) and various fine-tuning parameters for both the fingerprinting and recognition processes.
- Default value for configuration file: `CONFIG_FILE = config.json`

### config.json
This file serves as the configuration file for the distributed audio fingerprinting and result storage database instances, and the bearer token for authenticating fingerprinting requests.

#### Key Sections:
`fingerprinting`:

- `allow`: A boolean flag indicating whether fingerprinting is enabled or allowed (true or false).
- `token`: The bearer token used for authenticating fingerprinting requests.

`recognizing`:

- `max_duration`: Audio input to be recognized longer than the specified duration will be truncated to the `max_duration` value before being compared to the fingerprinting database.

`instances`:

Configuring the distributed set of audio fingerprinting database instances. Each instance defines a specific database configuration that the TuneScout system will connect to for storing and retrieving fingerprint audio data.

- `database`:
```
host: The database instance's IP address or hostname.
user: username of the database instance.
password: password to the database instance.
database: The name of the specific database to connect to.
port (optional): The port number the database instance is listening on. For MySQL instances, 3306 is the default port. For Clickhouse instances, 9000 is the default port.

```
- `database_type`: Specifies the type of database for a specific instance. Currently, `clickhouse` and `mysql` are supported.

`results`:

Configuring the distributed set of result storage database instances. Each instance defines a specific database configuration that the TuneScout system will connect to for storing and retrieving recognition results.

- `database`:
```
host: The database instance's IP address or hostname.
user: username of the database instance.
password: password to the database instance.
database: The name of the specific database to connect to.
port (optional): The port number the database instance is listening on. For MySQL instances, 3306 is the default port. For Clickhouse instances, 9000 is the default port.

```
- `database_type`: Specifies the type of database for a specific instance. Currently, `clickhouse` and `mysql` are supported.

#### config.json example
```
{
  "fingerprinting": {
    "allow": true,
    "token": "12345"
  },
  "recognizing": {
    "max_duration": 10
  },
  "instances": [
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "dejavu0",
        "port": 9000
      },
      "database_type": "clickhouse"
    },
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "dejavu1",
        "port": 9000
      },
      "database_type": "clickhouse"
    }
  ],
  "results": [
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "result0",
        "port": 9000
      },
      "database_type": "clickhouse"
    },
    {
      "database": {
        "host": "127.0.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "result1",
        "port": 9000
      },
      "database_type": "clickhouse"
    }
  ]
}
```
