## API Deployment

You can use Docker to easily deploy the TuneScout API server.

Simply pull the docker image:
```
docker pull bboymega/tunescout_api:v1.0.0
```
Prepare your `config.json`. Create your configuration file based on the example provided at the end of this readme.

Spin up a container with the following command:
```
docker run -d -p 8000:80 -v /path/to/your/config.json:/app/config.json bboymega/tunescout_api:v1.0.0
```

**FOR PRODUCTION**: Set up a reverse proxy using Apache2 or Nginx to expose the endpoint securely through HTTPS.


## API Endpoints

### /api/recognize
This endpoint is responsible for processing and recognizing audio input, such as recorded music tracks. When an audio file or stream is submitted to this endpoint, it analyzes the audio's unique fingerprint and compares it against a distributed set of configured audio fingerprinting database instances to identify the music being played. 

The recognition result is stored across a distributed set of configured result storage database instances, which can later be retrieved via a unique `result_token`. The endpoint returns a JSON object containing the top 3 most likely recognitions, based on the comparison with the fingerprinting database set.

Method: `POST`

Parameters:

| **Parameter**         | **Type**              | **Description**                                                                                                                                             | **Default**                                  |
| --------------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| `audio_or_video_file` | `multipart/form-data` | The audio or video file (or stream) to be recognized. Submit using the `file` parameter. Supported formats: MP3, WAV, MP4, etc.                             | None (Required)                              |
| `start` (optional)    | `integer` (seconds)   | The timestamp (in seconds) to start the recognition from. If not provided, recognition starts at the beginning of the file.                                 | `0` (start of the file)                      |
| `duration` (optional) | `integer` (seconds)   | The duration (in seconds) of the media to recognize starting from the `start` timestamp. If not provided, the entire media from `start` will be recognized. | `max_duration` (configured in `config.json`) |

Example with Parameters for the Python `requests` Library:

```
files = {'file': (f.name, f, mime_type)}
data = {'start': '0', 'duration': '10'} # optional
```

Response:

| **Field**   | **Description**                                                                                                  |
| ----------- | ---------------------------------------------------------------------------------------------------------------- |
| `results` | A JSON array containing the top 3 most probable recognitions. Each includes the track name and confidence score. |
| `status`  | Indicates whether the recognition process was successful (`"success"`) or failed (`"error"`).                    |
| `token`   | A unique token that can be used to retrieve this recognition result.                                             |
| `message` | An error message if the process fails (in case of `"status": "error"`), or if there’s an issue with the request. |


### /api/fetch/<Result_Token>
This endpoint retrieves detailed information about a previously recognized audio track, using the unique result token generated by the `/api/recognize` endpoint.

Method: `GET`

Parameters:

| **Parameter**        | **Description**                                                                                                       |
| -------------------- | --------------------------------------------------------------------------------------------------------------------- |
| `<Result_Token>` | A unique result token that is associated with a recognized track. This token is used to retrieve recognition results. |


Response:

| **Field**     | **Description**                                                                                                              |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `results`| A JSON array containing the top 3 most probable recognitions. Each recognition includes the track name and confidence score. |
| `status`  | Indicates whether the recognition process was successful (`"success"`) or failed (`"error"`).                                |
| `token`   | A unique token that can be used to retrieve this recognition result.                                                         |
| `message` | An error message if the process fails (in case of `"status": "error"`), or if there’s an issue with the request.             |


### /api/fingerprint
This endpoint allows you to submit an audio sample for fingerprinting, which can later be used for matching or recognition purposes. This endpoint is useful for generating a fingerprint for tracks you wish to store and compare later against future recognition requests.

Method: `POST`

Headers:

| **Field**           | **Description**                                                                                               |
| ------------------- | ------------------------------------------------------------------------------------------------------------- |
| `{token}` | The required authorization header for submission. It should be formatted as: `Authorization: Bearer {token}`. |

- **Example**: `Authorization: Bearer 12345`


Parameters:
| **Field**                 | **Type**                                   | **Description**                                                                                                    |
| ------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------ |
| `audio_or_video_file` | `multipart/form-data`                      | The audio or video file (or stream) to be fingerprinted, submitted via the `file` parameter.                       |

- Example with Parameters for the Python `requests` Library: 

```
header = { 'Authorization': f'Bearer 12345' }
files = {'file': (f.name, f, mime_type)}
```
- **Alternative Method**: You can also use the `tunescout_uploader` to upload audio samples for fingerprinting.

Response:

| **Field**       | **Description**                                                                                                                                      |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| `file_sha1` | The SHA-1 hash of the submitted audio file after being converted and normalized by the backend.     |
| `status`    | Indicates whether the fingerprinting process was successful (`"success"`) or if the file has already been fingerprinted (`"already_fingerprinted"`). |
| `message`   | An error message if the process fails (when `{ "status": "error" }`), or if there’s an issue with the request.                                       |


## Configuration Files

### ./dejavu/config/settings.py
This file serves as the master settings file for the TuneScout music recognition system. It controls key configuration aspects, including the path to the database configuration file (default: `./config.json`) and various fine-tuning parameters for both the fingerprinting and recognition processes.
- Default value for configuration file: `CONFIG_FILE = config.json`

### config.json
This file serves as the configuration file for the distributed audio fingerprinting and result storage database instances, and the bearer token for authenticating fingerprinting requests.

#### Key Sections
`fingerprinting`:

| Key     | Description                                                                  | Default Value |
| ------- | ---------------------------------------------------------------------------- | ------------- |
| `allow` | A boolean flag indicating whether fingerprinting is enabled (true or false). | `true`        |
| `token` | The bearer token used for authenticating fingerprinting requests.            | `None`        |

`recognizing`:

| Key                | Description                                                                                  | Default Value     |
| ------------------ | -------------------------------------------------------------------------------------------- | ----------------- |
| `max_duration`     | The maximum duration (in seconds) for audio input. Audio longer than this will be truncated. | `None` (No limit) |
| `max_file_size_mb` | The maximum file size (in MB) allowed for audio input.                                       | `None` (No limit) |

`redis`:

Configuring Redis for fingerprint query caching.

| Key                   | Description                                                         | Default Value |
| --------------------- | ------------------------------------------------------------------- | ------------- |
| `host`                | The hostname or IP address of the Redis server.                     | `localhost`   |
| `user` (optional)     | The username to authenticate with the Redis server (if applicable). | `None`        |
| `password` (optional) | The password for connecting to the Redis server (if applicable).    | `None`        |
| `prefix` (optional)   | A string used as the key prefix to store cached data.               | `None`        |
| `port` (optional)     | The port number of the Redis server.                                | `6379`        |


`rate_limit`:

Configuring rate limiting to prevent abuse and ensure fair usage. The rate limits for **fetching results**, **recognizing**, and **fingerprinting** can be set independently.

| Keys               | Description                                                   | Default Value     |
|-----------------------|---------------------------------------------------------------|-------------------|
| `fetching_results`    | The maximum number of requests allowed for fetching results within the time window. | `50 per second` |
| `recognizing`         | The maximum number of requests allowed for recognizing fingerprints within the time window. | `10 per second` |
| `fingerprinting`      | The maximum number of fingerprint creation requests within the time window. | `10 per second` |
| `redis_db_index`      | The Redis database index to use for storing rate limit information. | `0`               |

`allowed_origin`:

Configuring the allowed sources that are allowed to access the API endpoints via cross-origin requests.

| Key              | Description                                                             | Default Value     |
| ---------------- | ----------------------------------------------------------------------- | ----------------- |
| `allowed_origin` | A list of allowed origins (URLs) that can make requests to your system. | `[]` (empty list) |


`instances`:

Configuring the distributed set of audio fingerprinting database instances. Each instance defines a specific database configuration that the TuneScout system will connect to for storing and retrieving fingerprint audio data.

- `database`:

| Key               | Description                                                                                                                               | Default Value                           |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| `host`            | The database instance's IP address or hostname.                                                                                           | `127.0.0.1`                             |
| `user`            | The username for the database instance.                                                                                                   | `None`                                  |
| `password`        | The password to authenticate with the database instance.                                                                                  | `None`                                  |
| `database`        | The name of the specific database to connect to.                                                                                          | `None`                                  |
| `port` (optional) | The port number the database instance is listening on. For MySQL, the default port is `3306`. For Clickhouse, the default port is `9000`. | `3306` for MySQL, `9000` for Clickhouse |

- `database_type`: Specifies the type of database for a specific instance. Currently, `clickhouse` and `mysql` are supported.
- `redis_db_index`: Specifies the Redis cache database index used for a specific instance. This must be a unique integer value for each Redis instance to avoid conflicts between caches.

`results`:

Configuring the distributed set of result storage database instances. Each instance defines a specific database configuration that the TuneScout system will connect to for storing and retrieving recognition results.

- `database`:

| Key               | Description                                                                                                                               | Default Value                           |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| `host`            | The database instance's IP address or hostname.                                                                                           | `127.0.0.1`                             |
| `user`            | The username for the database instance.                                                                                                   | `None`                                  |
| `password`        | The password to authenticate with the database instance.                                                                                  | `None`                                  |
| `database`        | The name of the specific database to connect to.                                                                                          | `None`                                  |
| `port` (optional) | The port number the database instance is listening on. For MySQL, the default port is `3306`. For Clickhouse, the default port is `9000`. | `3306` for MySQL, `9000` for Clickhouse |

- `database_type`: Specifies the type of database for a specific instance. Currently, `clickhouse` and `mysql` are supported.

#### config.json example
```
{
  "fingerprinting": {
    "allow": true,
    "token": "12345"
  },
  "recognizing": {
    "max_duration": 10,
    "max_file_size_mb": 150
  },
  "redis": {
    "host": "172.17.0.1",
    "user": "dejavu",
    "password": "dejavu",
    "prefix": "dejavu",
    "port": 6379
  },
  "rate_limit": {
    "fetching_results": "50 per second",
    "recognizing": "10 per second",
    "fingerprinting": "10 per second",
    "redis_db_index": 0
  },
  "allowed_origin": ["https://example.com", "*"],
  "instances": [
    {
      "database": {
        "host": "172.17.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "dejavu0",
        "port": 9000
      },
      "redis_db_index": 1,
      "database_type": "clickhouse"
    },
    {
      "database": {
        "host": "172.17.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "dejavu1",
        "port": 9000
      },
      "redis_db_index": 2,
      "database_type": "clickhouse"
    }
  ],
  "results": [
    {
      "database": {
        "host": "172.17.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "result0",
        "port": 9000
      },
      "database_type": "clickhouse"
    },
    {
      "database": {
        "host": "172.17.0.1",
        "user": "dejavu",
        "password": "dejavu",
        "database": "result1",
        "port": 9000
      },
      "database_type": "clickhouse"
    }
  ]
}
```
